<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Census Data Extraction Tool</title>
    <style>
        * { box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            margin: 0; 
            padding: 20px; 
            background: white; 
        }
        main { 
            max-width: 500px; 
            margin: 0 auto; 
            padding: 20px; 
        }
        h1 { 
            margin: 0 0 10px 0; 
            color: #333; 
            font-size: 24px; 
            font-weight: 600; 
        }
        .sub { 
            color: #666; 
            margin: 0 0 30px 0; 
            line-height: 1.5; 
            font-size: 14px;
        }
        label { 
            display: block; 
            margin: 20px 0 8px 0; 
            font-weight: 500; 
            color: #333; 
            font-size: 14px;
        }
        input { 
            width: 100%; 
            padding: 12px; 
            border: 1px solid #ddd; 
            border-radius: 4px; 
            font-size: 16px; 
            background: #f8f9fa;
        }
        input:focus { 
            outline: none; 
            border-color: #007bff; 
        }
        .or { 
            text-align: center; 
            margin: 20px 0; 
            color: #666; 
            font-weight: 500; 
            font-size: 14px;
        }
        .coord-input {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
        }
        .coord-input input {
            flex: 1;
        }
        .coord-btn {
            width: 32px;
            height: 32px;
            border: 1px solid #ddd;
            background: #f8f9fa;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            color: #666;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .coord-btn:hover {
            background: #e9ecef;
        }
        .actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        button { 
            flex: 1;
            padding: 12px 24px; 
            border: none; 
            border-radius: 4px; 
            font-size: 16px; 
            font-weight: 500; 
            cursor: pointer; 
            background: #007bff; 
            color: white; 
        }
        
        #download {
            background: #6c757d;
        }
        button:hover:not(:disabled) { 
            background: #0056b3; 
        }
        button:disabled { 
            background: #ccc; 
            cursor: not-allowed; 
        }
        #msg { 
            margin: 20px 0; 
        }
        .error { 
            background: #f8d7da; 
            color: #721c24; 
            padding: 12px; 
            border-radius: 4px; 
            border: 1px solid #f5c6cb; 
        }
        .success { 
            background: #d4edda; 
            color: #155724; 
            padding: 12px; 
            border-radius: 4px; 
            border: 1px solid #c3e6cb; 
        }
        #result { 
            margin-top: 30px; 
        }
        .card { 
            background: #f8f9fa; 
            padding: 20px; 
            border-radius: 4px; 
            margin-bottom: 20px; 
        }
        .grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 15px; 
        }
        .stat { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 8px 0; 
            border-bottom: 1px solid #e9ecef; 
        }
        .stat:last-child { 
            border-bottom: none; 
        }
        .label { 
            font-weight: 500; 
            color: #666; 
        }
        .value { 
            font-weight: 600; 
            color: #333; 
        }
        details { 
            margin-top: 20px; 
        }
        summary { 
            cursor: pointer; 
            padding: 10px; 
            background: #f8f9fa; 
            border-radius: 4px; 
            font-weight: 500; 
        }
        pre { 
            background: #f8f9fa; 
            padding: 15px; 
            border-radius: 4px; 
            overflow-x: auto; 
            font-size: 14px; 
            margin: 10px 0 0 0; 
        }
    </style>
</head>
<body>
    <main id="app">
        <h1>Census Data Extraction Tool</h1>
        <p class="sub">Extract ACS demographic and housing statistics for a 1km grid cell around any US address or coordinates.</p>

        <label for="address">Enter an address</label>
        <input id="address" type="text" placeholder="e.g., 77 Massachusetts Ave, Cambridge, MA" autocomplete="street-address">

        <div class="or">Or enter Latitude</div>
        <div class="coord-input">
            <input id="lat" type="number" step="0.000001" value="0.000000">
            <button type="button" class="coord-btn" onclick="adjustCoord('lat', -0.000001)">-</button>
            <button type="button" class="coord-btn" onclick="adjustCoord('lat', 0.000001)">+</button>
        </div>

        <div>And Longitude</div>
        <div class="coord-input">
            <input id="lon" type="number" step="0.000001" value="0.000000">
            <button type="button" class="coord-btn" onclick="adjustCoord('lon', -0.000001)">-</button>
            <button type="button" class="coord-btn" onclick="adjustCoord('lon', 0.000001)">+</button>
        </div>

        <div class="actions">
            <button id="extract">Extract Census Data</button>
            <button id="download">Download CSV</button>
        </div>

        <div id="msg" aria-live="polite"></div>

        <section id="result" hidden>
            <div class="card" id="summary"></div>
            <details>
                <summary>Show full JSON</summary>
                <pre id="json"></pre>
            </details>
        </section>
    </main>

    <script>
        const API_BASE = "";

        function adjustCoord(field, delta) {
            const input = document.getElementById(field);
            const current = parseFloat(input.value) || 0;
            input.value = (current + delta).toFixed(6);
        }

        function readForm() {
            return {
                address: document.getElementById('address').value.trim() || null,
                lat: parseFloat(document.getElementById('lat').value) || null,
                lon: parseFloat(document.getElementById('lon').value) || null,
                cell_km: 1.0,
                acs_year: 2023,
                lodes_year: null
            };
        }

        function validate(p) {
            if (!p.address && (p.lat === null || p.lon === null)) {
                return "Please enter either an address or both latitude and longitude.";
            }
            if (p.lat !== null && (p.lat < -90 || p.lat > 90)) {
                return "Latitude must be between -90 and 90.";
            }
            if (p.lon !== null && (p.lon < -180 || p.lon > 180)) {
                return "Longitude must be between -180 and 180.";
            }
            return null;
        }

        function renderSummary(data) {
            // Check if data and metrics exist
            if (!data || !data.metrics) {
                return '<div class="error">No data available</div>';
            }
            
            const metrics = data.metrics;
            
            // Helper function to safely format numbers
            function safeFormat(value, prefix = '') {
                if (value === null || value === undefined || isNaN(value)) return 'N/A';
                try {
                    return prefix + value.toLocaleString();
                } catch (e) {
                    return 'N/A';
                }
            }
            
            return `
                <h3>Summary</h3>
                <div class="grid">
                    <div class="stat">
                        <span class="label">Population:</span>
                        <span class="value">${safeFormat(metrics.population?.total)}</span>
                    </div>
                    <div class="stat">
                        <span class="label">Households:</span>
                        <span class="value">${safeFormat(metrics.households?.total)}</span>
                    </div>
                    <div class="stat">
                        <span class="label">Median Income:</span>
                        <span class="value">$${safeFormat(metrics.income?.median)}</span>
                    </div>
                    <div class="stat">
                        <span class="label">Housing Units:</span>
                        <span class="value">${safeFormat(metrics.housing?.units_total)}</span>
                    </div>
                </div>
            `;
        }

        async function postJSON(url, payload) {
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || `HTTP ${response.status}`);
            }
            return await response.json();
        }

        function showError(msg) {
            const msgEl = document.getElementById('msg');
            msgEl.innerHTML = `<div class="error">${msg}</div>`;
            msgEl.hidden = false;
        }

        function showSuccess(msg) {
            const msgEl = document.getElementById('msg');
            msgEl.innerHTML = `<div class="success">${msg}</div>`;
            msgEl.hidden = false;
        }

        function clearMsg() {
            document.getElementById('msg').hidden = true;
        }

        async function handleExtract() {
            clearMsg();
            const payload = readForm();
            const error = validate(payload);
            if (error) {
                showError(error);
                return;
            }

            const extractBtn = document.getElementById('extract');
            extractBtn.disabled = true;
            extractBtn.textContent = 'Extracting...';

            try {
                const data = await postJSON(`${API_BASE}/grid_stats`, payload);
                document.getElementById('summary').innerHTML = renderSummary(data);
                document.getElementById('json').textContent = JSON.stringify(data, null, 2);
                document.getElementById('result').hidden = false;
                showSuccess('Data extracted successfully!');
            } catch (err) {
                showError(`Error: ${err.message}`);
            } finally {
                extractBtn.disabled = false;
                extractBtn.textContent = 'Extract Census Data';
            }
        }

        async function handleDownload() {
            clearMsg();
            const payload = readForm();
            const error = validate(payload);
            if (error) {
                showError(error);
                return;
            }

            const downloadBtn = document.getElementById('download');
            downloadBtn.disabled = true;
            downloadBtn.textContent = 'Downloading...';

            try {
                const response = await fetch(`${API_BASE}/grid_stats.csv`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || `HTTP ${response.status}`);
                }

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `census_data_${Date.now()}.csv`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                showSuccess('CSV downloaded successfully!');
            } catch (err) {
                showError(`Error: ${err.message}`);
            } finally {
                downloadBtn.disabled = false;
                downloadBtn.textContent = 'Download CSV';
            }
        }

        document.getElementById('extract').addEventListener('click', handleExtract);
        document.getElementById('download').addEventListener('click', handleDownload);
    </script>
</body>
</html>